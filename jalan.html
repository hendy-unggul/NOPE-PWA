<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.png">
  <meta name="theme-color" content="#0b2a4d">
  <title>Jalan ‚Ä¢ NOPE</title>
  <style>
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Helvetica, Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      padding-bottom: calc(68px + var(--safe-bottom));
    }

    .container {
      max-width: 390px;
      margin: 0 auto;
      padding: 16px 12px;
    }

    /* Tab Navigation */
    .feed-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 16px;
      padding: 0 4px;
    }

    .tab-btn {
      flex: 1;
      padding: 8px 0;
      background: none;
      border: none;
      color: #888;
      font-size: 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: rgba(11, 42, 77, 0.2);
      color: #0b2a4d;
    }

    /* Feed Item */
    .feed-item {
      background: #0a0a0a;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }

    .username {
      color: #0b2a4d;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      cursor: pointer;
    }

    .username:hover {
      text-decoration: underline;
    }

    .rant-text {
      margin-bottom: 12px;
      white-space: pre-line;
      line-height: 1.5;
    }

    .artefact-preview {
      width: 100%;
      aspect-ratio: 1 / 0.8;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .artefact-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .artefact-stamp {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 12px;
    }

    .artefact-notasi {
      font-weight: 600;
      color: #fff;
    }

    /* Emoji Bar */
    .emoji-bar {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .emoji-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.8;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      opacity: 1;
      color: #fff;
      transform: scale(1.2);
    }

    /* Comment Box (hanya untuk sefrekuensi) */
    .comment-box {
      margin-top: 12px;
      display: none;
    }

    .comment-input {
      width: 100%;
      padding: 10px;
      background: #111;
      border: 1px solid #222;
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .comment-btn {
      background: #0b2a4d;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .comments-list {
      margin-top: 12px;
      font-size: 14px;
    }

    .comment-item {
      margin-bottom: 8px;
    }

    .comment-author {
      color: #0b2a4d;
      font-weight: 600;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: #000;
      border-top: 1px solid #1a1a1a;
      padding-bottom: var(--safe-bottom);
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      font-size: 12px;
      color: #666;
      text-decoration: none;
    }

    .nav-item.active {
      color: #0b2a4d;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="feed-tabs">
      <button class="tab-btn active" onclick="switchFeed('global')">üåç Segelombang</button>
      <button class="tab-btn" onclick="switchFeed('freq')">üì° Sefrekuensi</button>
    </div>

    <div id="feedContent">
      <!-- Diisi oleh JS -->
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="/jejak" class="nav-item">Jejak</a>
    <a href="/dunia" class="nav-item active">Jalan</a>
    <a href="/jalan" class="nav-item">Jalan</a>
  </nav>

  <script>
    // ==== DATA DUMMY ====
    const currentUser = {
      username: "@nope.anon",
      frequency: {
        pop: "#FilmEndingGaje",
        pain: "#DighostingGebetan",
        sick: "#RencanaPlinPlan"
      }
    };

    // Semua user
    const allUsers = [
      {
        username: "@nope.bangga.aura.1234",
        frequency: { pop: "#FilmEndingGaje", pain: "#DighostingGebetan", sick: "#RencanaPlinPlan" },
        rants: [
          { text: "hari ini aku bilang 'ga apa-apa' padahal hati retak...", timestamp: "2025-06-14T10:00:00Z" }
        ],
        artefacts: [
          { url: "https://i.imgur.com/8Xz9Y7p.jpeg", notasi: "tiket bioskop", date: "2025-05-10T10:00:00Z" }
        ]
      },
      {
        username: "@nope.tenang.jiwa.3456",
        frequency: { pop: "#MusikNostalgia", pain: "#DighostingGebetan", sick: "#RencanaPlinPlan" },
        rants: [
          { text: "diamku bukan kosong. di dalam, aku sedang menulis puisi...", timestamp: "2025-06-10T10:00:00Z" }
        ],
        artefacts: []
      }
    ];

    // Cek apakah dua user sefrekuensi
    function isSameFrequency(freq1, freq2) {
      return freq1.pop === freq2.pop && freq1.pain === freq2.pain && freq1.sick === freq2.sick;
    }

    // Gabung rant & artefak dengan pola 3 rant : 1 artefak
    function mergeFeed(rants, artefacts) {
      const feed = [];
      let artIndex = 0;
      for (let i = 0; i < rants.length; i++) {
        feed.push({ type: 'rant', ...rants[i] });
        if ((i + 1) % 3 === 0 && artIndex < artefacts.length) {
          feed.push({ type: 'artefact', ...artefacts[artIndex] });
          artIndex++;
        }
      }
      // Tambahkan sisa artefak di akhir
      while (artIndex < artefacts.length) {
        feed.push({ type: 'artefact', ...artefacts[artIndex] });
        artIndex++;
      }
      return feed;
    }

    // Render feed
    function renderFeed(feedType) {
      const feedContent = document.getElementById('feedContent');
      feedContent.innerHTML = '';

      let allRants = [];
      let allArtefacts = [];

      if (feedType === 'global') {
        // Ambil semua
        allUsers.forEach(user => {
          user.rants.forEach(rant => {
            allRants.push({ ...rant, author: user.username });
          });
          user.artefacts.forEach(art => {
            allArtefacts.push({ ...art, author: user.username });
          });
        });
      } else if (feedType === 'freq') {
        // Hanya yang sefrekuensi
        allUsers.forEach(user => {
          if (isSameFrequency(user.frequency, currentUser.frequency)) {
            user.rants.forEach(rant => {
              allRants.push({ ...rant, author: user.username });
            });
            user.artefacts.forEach(art => {
              allArtefacts.push({ ...art, author: user.username });
            });
          }
        });
      }

      // Urutkan terbaru dulu
      allRants.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      allArtefacts.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Gabung dengan pola
      const mergedFeed = mergeFeed(allRants, allArtefacts);

      // Render
      mergedFeed.forEach(item => {
        const div = document.createElement('div');
        div.className = 'feed-item';

        if (item.type === 'rant') {
          const isFreq = feedType === 'freq' && isSameFrequency(
            allUsers.find(u => u.username === item.author)?.frequency, 
            currentUser.frequency
          );

          div.innerHTML = `
            <div class="username" onclick="viewProfile('${item.author}')">${item.author}</div>
            <div class="rant-text">${item.text}</div>
            <div class "emoji-bar">
              <button class="emoji-btn" title="GueJuga">üñ§</button>
              <button class="emoji-btn" title="Peluk">ü§ó</button>
              <button class="emoji-btn" title="Bangga">üåü</button>
            </div>
            ${isFreq ? `
              <div class="comment-box">
                <input type="text" class="comment-input" placeholder="120 huruf..." maxlength="120">
                <button class="comment-btn">Kirim</button>
                <div class="comments-list"></div>
              </div>
            ` : ''}
          `;
        } else if (item.type === 'artefact') {
          const dateStr = new Date(item.date).toLocaleDateString('id-ID', {
            day: 'numeric', month: 'short', year: 'numeric'
          });
          const notasiPart = item.notasi ? `<span class="artefact-notasi">${item.notasi}</span> ` : '';
          div.innerHTML = `
            <div class="username" onclick="viewProfile('${item.author}')">${item.author}</div>
            <div class="artefact-preview">
              <img src="${item.url}" alt="Artefak">
            </div>
            <div class="artefact-stamp">${notasiPart}${dateStr}</div>
            <div class="emoji-bar">
              <button class="emoji-btn" title="GueJuga">üñ§</button>
              <button class="emoji-btn" title="Peluk">ü§ó</button>
              <button class="emoji-btn" title="Bangga">üåü</button>
            </div>
          `;
        }

        feedContent.appendChild(div);
      });
    }

    function switchFeed(feedType) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      renderFeed(feedType);
    }

    function viewProfile(username) {
      // Bisa arahkan ke jejak.html?user=username
      alert(`Intip jejak ${username}`);
    }

    // Init
    if (!localStorage.getItem('nopeOnboarded')) {
      window.location.href = '/index.html';
    }

    renderFeed('global');

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.warn);
      });
    }
  </script>
</body>
</html>
